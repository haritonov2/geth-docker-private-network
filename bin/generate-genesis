#!/bin/bash
# The script Generates genesis block for a new main node.

echo Be sure to generate geth account firts: \"geth account new\".

alloc_balances=""
genesis_template_file="$(dirname $0)/../genesis-template.json"

# Export variables from ".env" file.
export $(grep -v '^#' "$(dirname $0)/../.env" | xargs)

if [ -z $ETH_KEYSTORE_DIR ];
then
  echo You should define \"ETH_KEYSTORE_DIR\" environment variable.
  exit 1
fi

# Loop over all Ethereum accounts.
for account_file in ${ETH_KEYSTORE_DIR}/*; do
  account="$(cat $account_file)"
  pattern='address":"([a-zA-Z0-9]+)"'

  # Continue if an account doesn't have an address.
  [[ $account =~ $pattern ]] || continue

  if [[ $alloc_balances != "" ]]
  then
    alloc_balances+=", "
  fi

  # Prepare balances allocation for all Ethereum accounts.
  alloc_balances+="\"0x${BASH_REMATCH[1]}\": { \"balance\": \"100000000000000000000000000000\" }"
done;

genesis="$(sed "s/\"alloc\": {}/\"alloc\": { $alloc_balances }/" $genesis_template_file)"

echo $genesis > "$(dirname $0)/../genesis.json"
